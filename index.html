<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏û‡∏∞‡πÄ‡∏¢‡∏≤‡∏£‡∏≤‡∏° - Google Apps Script</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .gradient-orange {
            background: linear-gradient(135deg, #fed7aa, #fb923c);
        }
        .sidebar-gradient {
            background: linear-gradient(180deg, #fb923c, #ea580c);
        }
        .login-gradient {
            background: linear-gradient(135deg, #fb923c, #ea580c);
        }
        .swal2-popup {
            font-family: 'Sarabun', sans-serif !important;
        }
        /* For smooth transitions */
        #sidebar, #mainContent {
            transition: all 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-orange-100 font-sans">
    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div class="text-center">
                <h1 class="text-4xl font-bold text-orange-600 mb-2">üçú</h1>
                <h2 class="text-3xl font-bold text-gray-900">‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏û‡∏∞‡πÄ‡∏¢‡∏≤‡∏£‡∏≤‡∏°</h2>
                <p class="mt-2 text-sm text-gray-600">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
            </div>
            <div class="bg-white rounded-lg shadow-lg p-8">
                <form id="loginForm" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                        <input type="text" id="username" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                        <input type="password" id="password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" required>
                    </div>
                    <button type="submit" class="w-full login-gradient text-white py-3 px-4 rounded-lg hover:opacity-90 transition-opacity font-medium">
                        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                </form>
                <div class="mt-6 p-4 bg-gray-50 rounded-lg hidden">
                    <h3 class="font-medium text-gray-700 mb-2">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏î‡∏™‡∏≠‡∏ö:</h3>
                    <div class="text-sm text-gray-600 space-y-1">
                        <p><strong>Admin:</strong> admin / pyr054411111</p>
                        <p><strong>User ‡∏Ç‡∏≤‡∏¢:</strong> user / user123</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="flex h-screen bg-gray-100 hidden">
        <!-- Sidebar -->
        <div id="sidebar" class="fixed inset-y-0 left-0 z-30 w-64 sidebar-gradient text-white shadow-lg transform -translate-x-full md:relative md:translate-x-0 flex flex-col">
            <div class="p-6 flex-shrink-0">
                <h1 class="text-xl font-bold mb-4 nav-text">üçú ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏û‡∏∞‡πÄ‡∏¢‡∏≤‡∏£‡∏≤‡∏°</h1>
                <div class="mb-6 p-3 bg-orange-600 rounded-lg">
                    <p class="text-sm">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: <span id="currentUser" class="font-medium"></span></p>
                    <p class="text-xs opacity-75 nav-text">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: <span id="currentRole" class="font-medium"></span></p>
                </div>
            </div>

            <nav class="flex-1 px-4 space-y-2 overflow-y-auto" id="navigation">
                <!-- Navigation links populated by JS -->
            </nav>

            <div class="px-4 pb-4 mt-auto flex-shrink-0">
                <button id="desktopSidebarToggler" class="w-full p-3 rounded-lg hover:bg-orange-600 hidden md:flex items-center">
                    <svg id="desktopTogglerIcon" class="w-6 h-6 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path></svg>
                    <span class="nav-text ml-2">‡∏¢‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π</span>
                </button>
                <button onclick="logout()" class="w-full mt-2 bg-red-500 hover:bg-red-600 text-white p-3 rounded-lg flex items-center justify-center">
                     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    <span class="nav-text ml-2">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div id="mainContent" class="flex-1 flex flex-col w-full md:w-auto">
             <!-- Mobile Header -->
            <div class="md:hidden flex justify-between items-center bg-white p-4 shadow-md sticky top-0 z-10">
                <h1 class="text-lg font-bold text-orange-600">üçú ‡∏û‡∏∞‡πÄ‡∏¢‡∏≤‡∏£‡∏≤‡∏°</h1>
                <button id="mobileHamburgerBtn" aria-label="Open Menu">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
            </div>

            <!-- Content Area -->
            <div class="flex-1 p-4 md:p-6 overflow-y-auto">
                 <!-- Home Page -->
                <div id="homePage" class="page">
                    <div class="gradient-orange rounded-lg p-6 mb-6">
                        <h2 class="text-2xl font-bold text-white mb-4">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏û‡∏∞‡πÄ‡∏¢‡∏≤‡∏£‡∏≤‡∏°</h2>
                        <p class="text-orange-100">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏á‡πà‡∏≤‡∏¢‡∏î‡∏≤‡∏¢</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="bg-white rounded-lg p-6 shadow-md">
                            <h3 class="text-lg font-semibold mb-2 text-gray-700">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                            <p class="text-3xl font-bold text-green-600" id="todaySales">‡∏ø0</p>
                        </div>
                        <div class="bg-white rounded-lg p-6 shadow-md">
                            <h3 class="text-lg font-semibold mb-2 text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
                            <p class="text-3xl font-bold text-blue-600" id="memberCount">0</p>
                        </div>
                        <div class="bg-white rounded-lg p-6 shadow-md">
                            <h3 class="text-lg font-semibold mb-2 text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                            <p class="text-3xl font-bold text-yellow-600" id="productCount">0</p>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg p-6 shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-700">‡∏Ç‡πà‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</h3>
                            <button id="editAnnouncementsBtn" onclick="editAnnouncements()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm hidden">
                                ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                            </button>
                        </div>
                        <div id="announcementsContainer" class="space-y-2">
                           <!-- Announcements will be rendered here by JS -->
                        </div>
                    </div>
                    
                </div>

                <!-- Add Product Page (Admin Only) -->
                <div id="addProductPage" class="page hidden">
                    <div class="bg-white rounded-lg p-6 shadow-md">
                        <h2 class="text-2xl font-bold mb-6 text-gray-800">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
                        <form id="productForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                                <input type="text" id="productName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" required>
                            </div>
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="block text-sm font-medium text-gray-700">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£</label>
                                    <button type="button" id="generateDescBtn" onclick="generateDescription()" class="text-sm text-orange-600 hover:text-orange-800 font-medium flex items-center space-x-1 disabled:opacity-50" disabled>
                                        <span>‚ú® ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>
                                        <svg id="descSpinner" class="animate-spin h-4 w-4 text-orange-600 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                           <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                           <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                    </button>
                               </div>
                                <textarea id="productDescription" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" rows="3"></textarea>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</label>
                                    <input type="number" id="productPrice" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</label>
                                    <input type="number" id="productStock" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" required>
                                </div>
                            </div>
                            <div class="flex">
                                <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg transition-colors flex-1">
                                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="bg-white rounded-lg p-6 shadow-md mt-6">
                        <h3 class="text-lg font-semibold mb-4 text-gray-700">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                        <div id="productList" class="space-y-2"></div>
                    </div>
                </div>

                <!-- Payment Page -->
                <div id="paymentPage" class="page hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Product Grid -->
                        <div class="bg-white rounded-lg p-6 shadow-md">
                            <h2 class="text-2xl font-bold mb-4 text-gray-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
                            <input type="text" id="productSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                            <div id="productGrid" class="grid grid-cols-2 sm:grid-cols-3 gap-4 max-h-[60vh] overflow-y-auto">
                                <!-- Product cards will be inserted here -->
                            </div>
                        </div>

                        <!-- Cart & Payment -->
                        <div class="bg-white rounded-lg p-6 shadow-md">
                             <h2 class="text-2xl font-bold mb-4 text-gray-800">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ & ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h2>
                             <div id="memberSelectContainer">
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</label>
                                <select id="memberSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 mb-4">
                                    <option value="">(‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)</option>
                                </select>
                            </div>
                            
                            <div id="cart" class="space-y-2 mb-4 max-h-40 overflow-y-auto"></div>
                            
                            <div class="border-t pt-4">
                                <div class="flex justify-between items-center mb-4">
                                    <span class="text-lg font-semibold">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</span>
                                    <span class="text-xl font-bold text-green-600" id="totalAmount">‡∏ø0</span>
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</label>
                                    <div class="flex items-center space-x-4">
                                        <div class="flex items-center">
                                            <input id="paymentCash" name="paymentMethod" type="radio" value="‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î" class="focus:ring-orange-500 h-4 w-4 text-orange-600 border-gray-300" checked>
                                            <label for="paymentCash" class="ml-2 block text-sm text-gray-900">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input id="paymentTransfer" name="paymentMethod" type="radio" value="‡πÇ‡∏≠‡∏ô" class="focus:ring-orange-500 h-4 w-4 text-orange-600 border-gray-300">
                                            <label for="paymentTransfer" class="ml-2 block text-sm text-gray-900">‡πÇ‡∏≠‡∏ô</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢</label>
                                        <input type="number" id="paidAmount" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" oninput="calculateChange()">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô</label>
                                        <input type="text" id="changeAmount" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100" readonly>
                                    </div>
                                </div>
                                <button onclick="confirmPayment()" class="w-full bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg transition-colors mt-4">
                                    ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add Member Page (Admin Only) -->
                <div id="addMemberPage" class="page hidden">
                    <div class="bg-white rounded-lg p-6 shadow-md">
                        <h2 class="text-2xl font-bold mb-6 text-gray-800">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
                        <form id="memberForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                                <input type="text" id="employeeId" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" required>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠</label>
                                    <input type="text" id="firstName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                                    <input type="text" id="lastName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" required>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡πÅ‡∏ú‡∏ô‡∏Å</label>
                                <input type="text" id="department" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" required>
                            </div>
                            <div class="flex">
                                <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg transition-colors flex-1">
                                    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="bg-white rounded-lg p-6 shadow-md mt-6">
                        <h3 class="text-lg font-semibold mb-4 text-gray-700">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
                        <div id="memberList" class="space-y-2"></div>
                    </div>
                </div>

                <!-- Sales Report Page (Admin Only) -->
                <div id="salesReportPage" class="page hidden">
                    <div class="bg-white rounded-lg p-6 shadow-md mb-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</h2>
                             <button onclick="loadFromGoogleSheets(true)" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition-colors flex items-center space-x-2">
                                <span>üîÑ</span>
                                <span>‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                            </button>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                <h3 class="text-sm font-medium text-green-700">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                                <p class="text-2xl font-bold text-green-600" id="reportTodaySales">‡∏ø0</p>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                <h3 class="text-sm font-medium text-blue-700">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</h3>
                                <p class="text-2xl font-bold text-blue-600" id="reportWeeklySales">‡∏ø0</p>
                            </div>
                            <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                                <h3 class="text-sm font-medium text-yellow-700">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</h3>
                                <p class="text-2xl font-bold text-yellow-600" id="reportMonthlySales">‡∏ø0</p>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                                <h3 class="text-sm font-medium text-purple-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
                                <p class="text-2xl font-bold text-purple-600" id="reportMemberCount">0</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-lg p-6 shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-gray-700">‡∏Å‡∏£‡∏≤‡∏ü‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</h3>
                            <div class="relative h-80">
                                <canvas id="salesChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg p-6 shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-gray-700">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ</h3>
                            <div id="topProducts" class="space-y-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Sales History Page (User can see their own sales) -->
                <div id="salesHistoryPage" class="page hidden">
                    <div class="bg-white rounded-lg p-6 shadow-md">
                        <h2 class="text-2xl font-bold mb-6 text-gray-800">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h2>
                        <div class="mb-4">
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                                    <h3 class="text-sm font-medium text-yellow-700">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° (‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô)</h3>
                                    <p class="text-2xl font-bold text-yellow-600" id="myTotalSales">‡∏ø0</p>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                    <h3 class="text-sm font-medium text-green-700">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î (‡∏£‡∏ß‡∏°)</h3>
                                    <p class="text-2xl font-bold text-green-600" id="myTotalCashSales">‡∏ø0</p>
                                </div>
                                <div class="bg-sky-50 p-4 rounded-lg border border-sky-200">
                                    <h3 class="text-sm font-medium text-sky-700">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÇ‡∏≠‡∏ô (‡∏£‡∏ß‡∏°)</h3>
                                    <p class="text-2xl font-bold text-sky-600" id="myTotalTransferSales">‡∏ø0</p>
                                </div>
                                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                    <h3 class="text-sm font-medium text-blue-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</h3>
                                    <p class="text-2xl font-bold text-blue-600" id="myOrdersToday">0</p>
                                </div>
                            </div>
                        </div>
                        <div id="mySalesList" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Sidebar Overlay for Mobile -->
        <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let userRole = null;
        let currentCart = [];
        let products = [];
        let members = [];
        let sales = [];
        let announcements = {
            promo1: "üéâ ‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà! ‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î‡∏û‡∏∞‡πÄ‡∏¢‡∏≤‡∏£‡∏≤‡∏° ‡∏û‡∏¥‡πÄ‡∏®‡∏© 45 ‡∏ö‡∏≤‡∏ó",
            promo2: "üì¢ ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ‡∏•‡∏î 10% ‡∏ó‡∏∏‡∏Å‡πÄ‡∏°‡∏ô‡∏π"
        };
        let salesChartInstance = null;
        
        const users = {
            'admin': { password: 'pyr054411111', role: 'admin', name: '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö' },
            'user': { password: 'user123', role: 'user', name: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢' }
        };

        const GOOGLE_SHEETS_URL = "https://script.google.com/macros/s/AKfycbzXKaskLapX_vzRartmVX74x7vnpMhiyVK6Wk2WUbVdnKJQXNL_2unioutQFzMEBfxg/exec";
        const GEMINI_API_KEY = "";
        
        async function fetchWithRetry(url, options, maxRetries = 3) {
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    if (attempt === maxRetries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                }
            }
        }

        async function generateDescription() {
            const productName = document.getElementById('productName').value;
            if (!productName.trim()) { showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô', 'warning'); return; }
            const generateBtn = document.getElementById('generateDescBtn');
            const spinner = document.getElementById('descSpinner');
            const descriptionArea = document.getElementById('productDescription');
            generateBtn.disabled = true;
            spinner.classList.remove('hidden');
            descriptionArea.value = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ AI ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢...";
            const prompt = `‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡∏î‡∏π‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ä‡∏∑‡πà‡∏≠ '${productName}' ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß 1-2 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ`;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            try {
                const result = await fetchWithRetry(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                descriptionArea.value = text ? text.trim() : "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢', 'error');
                descriptionArea.value = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
            } finally {
                generateBtn.disabled = false;
                spinner.classList.add('hidden');
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            checkLogin();
            document.getElementById('productName').addEventListener('input', (e) => {
                document.getElementById('generateDescBtn').disabled = !e.target.value.trim();
            });
            setupSidebarControls();
            document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
                radio.addEventListener('change', handlePaymentMethodChange);
            });
            document.getElementById('productSearch').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filtered = products.filter(p => p.name.toLowerCase().includes(searchTerm));
                displayProductGrid(filtered);
            });
        });

        function handlePaymentMethodChange() {
            const isTransfer = document.getElementById('paymentTransfer').checked;
            if (isTransfer) {
                const totalText = document.getElementById('totalAmount').textContent;
                const total = parseFloat(totalText.replace(/[^\d.-]/g, '')) || 0;
                const paidAmountInput = document.getElementById('paidAmount');
                paidAmountInput.value = total;
                calculateChange();
            }
        }

        function setupSidebarControls(){
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const mobileHamburgerBtn = document.getElementById('mobileHamburgerBtn');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const desktopSidebarToggler = document.getElementById('desktopSidebarToggler');
            const desktopTogglerIcon = document.getElementById('desktopTogglerIcon');
            const openMobileSidebar = () => { sidebar.classList.remove('-translate-x-full'); sidebarOverlay.classList.remove('hidden'); };
            const closeMobileSidebar = () => { sidebar.classList.add('-translate-x-full'); sidebarOverlay.classList.add('hidden'); };
            const toggleDesktopSidebar = () => {
                const isCollapsed = sidebar.classList.contains('w-20');
                localStorage.setItem('sidebarState', isCollapsed ? 'expanded' : 'collapsed');
                applyDesktopSidebarState();
            };
            const applyDesktopSidebarState = () => {
                const state = localStorage.getItem('sidebarState');
                const navTexts = document.querySelectorAll('.nav-text');
                const navButtons = document.querySelectorAll('#navigation button, #desktopSidebarToggler');
                if (state === 'collapsed') {
                    sidebar.classList.replace('w-64', 'w-20');
                    mainContent.classList.replace('md:ml-64', 'md:ml-20');
                    navTexts.forEach(text => text.classList.add('hidden'));
                    navButtons.forEach(btn => btn.classList.add('justify-center'));
                    desktopTogglerIcon.classList.add('rotate-180');
                } else {
                    sidebar.classList.replace('w-20', 'w-64');
                    mainContent.classList.replace('md:ml-20', 'md:ml-64');
                    navTexts.forEach(text => text.classList.remove('hidden'));
                    navButtons.forEach(btn => btn.classList.remove('justify-center'));
                    desktopTogglerIcon.classList.remove('rotate-180');
                }
            };
            mobileHamburgerBtn.addEventListener('click', openMobileSidebar);
            sidebarOverlay.addEventListener('click', closeMobileSidebar);
            desktopSidebarToggler.addEventListener('click', toggleDesktopSidebar);
            window.closeMobileSidebar = closeMobileSidebar;
            window.applyDesktopSidebarState = applyDesktopSidebarState;
        }

        // --- DATA SYNCING ---
        function syncDataToGoogleSheets() {
            const data = { products, members, sales, announcements, timestamp: new Date().toISOString(), savedBy: currentUser };
            const callbackName = 'jsonpCallback_sync_' + Date.now();
            window[callbackName] = function(response) {
                if (document.head.contains(script)) {
                    document.head.removeChild(script);
                }
                delete window[callbackName];
                if (!response.success) {
                    console.error("Auto-sync failed:", response.error);
                    showAlert('‡∏Å‡∏≤‡∏£‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error');
                }
            };
            const script = document.createElement('script');
            const params = new URLSearchParams({ action: 'save', data: JSON.stringify(data), callback: callbackName });
            
            const fullUrl = `${GOOGLE_SHEETS_URL}?${params.toString()}`;
            console.log("Attempting to sync with URL:", fullUrl); // This will show the exact URL being called in the F12 Console
            
            script.src = fullUrl;
            script.onerror = () => {
                 if (document.head.contains(script)) {
                    document.head.removeChild(script);
                }
                delete window[callbackName];
                console.error("Auto-sync failed: Network error");
                showAlert('‡∏Å‡∏≤‡∏£‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß! ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Deploy ‡πÅ‡∏•‡∏∞ URL', 'error');
            };
            document.head.appendChild(script);
        }

        function loadFromGoogleSheets(isManualRefresh = false) {
            if (isManualRefresh) {
                Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });
            }
            const callbackName = 'jsonpCallback_load_' + Date.now();
            window[callbackName] = function(response) {
                if (document.head.contains(script)) {
                    document.head.removeChild(script);
                }
                delete window[callbackName];
                if (response.success && response.data) {
                    products = response.data.products || [];
                    members = response.data.members || [];
                    sales = response.data.sales || [];
                    if (response.data.announcements) {
                        announcements = response.data.announcements;
                    }
                    refreshUI();
                    if (isManualRefresh) {
                        Swal.fire({ icon: 'success', title: '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', timer: 1500, showConfirmButton: false });
                    }
                } else {
                    if (isManualRefresh) {
                        Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', text: response.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ' });
                    } else {
                        showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏î‡πâ', 'error');
                    }
                }
            };
            const script = document.createElement('script');
            const params = new URLSearchParams({ action: 'load', callback: callbackName });
            script.src = `${GOOGLE_SHEETS_URL}?${params.toString()}`;
            script.onerror = function() {
                if (document.head.contains(script)) {
                    document.head.removeChild(script);
                }
                delete window[callbackName];
                 if (isManualRefresh) {
                    Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheets ‡πÑ‡∏î‡πâ' });
                } else {
                    showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
                }
            };
            document.head.appendChild(script);
        }

        // --- AUTH & UI FLOW ---
        function checkLogin() { showLoginPage(); }
        function showLoginPage() { document.getElementById('loginPage').classList.remove('hidden'); document.getElementById('mainApp').classList.add('hidden'); }

        function showMainApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('currentUser').textContent = users[currentUser]?.name || currentUser;
            document.getElementById('currentRole').textContent = userRole === 'admin' ? '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö' : '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢';
            
            // Role-specific UI adjustments
            const memberSelectContainer = document.getElementById('memberSelectContainer');
            if (memberSelectContainer) {
                if (userRole === 'user') {
                    memberSelectContainer.classList.add('hidden');
                } else {
                    memberSelectContainer.classList.remove('hidden');
                }
            }

            setupNavigation();
            showPage('home');
            
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            loadFromGoogleSheets(); // Load data from Sheets on login
            Swal.close();
            
            if (window.applyDesktopSidebarState) window.applyDesktopSidebarState();
        }

        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            if (users[username] && users[username].password === password) {
                currentUser = username;
                userRole = users[username].role;
                showAlert(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${users[username].name}`, 'success');
                setTimeout(() => { showMainApp(); }, 500);
            } else {
                showAlert('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
            }
        });

        function logout() {
            Swal.fire({ title: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö', text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', icon: 'question', showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6', confirmButtonText: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', reverseButtons: true })
            .then((result) => {
                if (result.isConfirmed) {
                    currentUser = null; userRole = null; currentCart = [];
                    Swal.fire({ icon: 'success', title: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1500, showConfirmButton: false }).then(() => {
                        showLoginPage();
                        document.getElementById('loginForm').reset();
                        document.getElementById('cart').innerHTML = '';
                        document.getElementById('totalAmount').textContent = '‡∏ø0';
                    });
                }
            });
        }
        
        function setupNavigation() {
            const nav = document.getElementById('navigation');
            nav.innerHTML = '';
            const p = [{ id: 'home', i: 'üè†', n: '‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å' }, { id: 'payment', i: 'üí∏', n: '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô' }];
            if (userRole === 'admin') p.push({ id: 'addProduct', i: 'üîº', n: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' }, { id: 'addMember', i: '‚ûï', n: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å' }, { id: 'salesReport', i: 'üìä', n: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢' });
            else p.push({ id: 'salesHistory', i: 'üìã', n: '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢' });
            p.forEach(page => {
                const btn = document.createElement('button');
                btn.onclick = () => { showPage(page.id); if (window.innerWidth < 768) window.closeMobileSidebar(); };
                btn.className = 'w-full text-left p-3 rounded-lg hover:bg-orange-600 transition-colors flex items-center';
                btn.innerHTML = `<span>${page.i}</span><span class="nav-text ml-2">${page.n}</span>`;
                nav.appendChild(btn);
            });
        }
        
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById(pageId + 'Page').classList.remove('hidden');
            if(pageId === 'payment') displayProductGrid(); // Render grid when showing payment page
            if (pageId === 'salesHistory') updateMySalesHistory();
            if (pageId === 'salesReport') updateSalesReport();
        }

        // --- CRUD Operations ---
        document.getElementById('productForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (userRole !== 'admin') { showAlert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå', 'error'); return; }
            const product = { 
                name: document.getElementById('productName').value, 
                description: document.getElementById('productDescription').value, 
                price: parseFloat(document.getElementById('productPrice').value), 
                stock: parseInt(document.getElementById('productStock').value), 
                createdAt: new Date().toISOString(), 
                createdBy: currentUser 
            };
            products.push(product);
            syncDataToGoogleSheets();
            Swal.fire({ icon: 'success', title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', timer: 1500, showConfirmButton: false });
            document.getElementById('productForm').reset();
            refreshUI();
        });

        function displayProducts() {
            const list = document.getElementById('productList');
            list.innerHTML = '';
            products.forEach((p, i) => {
                const div = document.createElement('div');
                div.className = 'p-3 bg-gray-50 rounded border flex flex-col sm:flex-row justify-between sm:items-center space-y-2 sm:space-y-0';
                div.innerHTML = `<div class="w-full sm:w-auto text-left"><h4 class="font-medium">${p.name}</h4><p class="text-sm text-gray-600">${p.description || ''}</p><p class="text-sm">‡∏£‡∏≤‡∏Ñ‡∏≤: ‡∏ø${p.price} | ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${p.stock}</p></div><div class="flex space-x-2 flex-shrink-0">${userRole === 'admin' ? `<button onclick="editProduct(${i})" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button><button onclick="deleteProduct(${i})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">‡∏•‡∏ö</button>` : ''}</div>`;
                list.appendChild(div);
            });
        }
        
        function editProduct(index) {
            if (userRole !== 'admin') { showAlert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå', 'error'); return; }
            const p = products[index];
            Swal.fire({ title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', html: `<div class="space-y-4 text-left"><div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><input id="swal-productName" class="swal2-input w-full" value="${p.name}"></div><div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label><textarea id="swal-productDescription" class="swal2-textarea w-full">${p.description || ''}</textarea></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤</label><input id="swal-productPrice" type="number" class="swal2-input w-full" value="${p.price}"></div><div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</label><input id="swal-productStock" type="number" class="swal2-input w-full" value="${p.stock}"></div></div></div>`, focusConfirm: false, showCancelButton: true, confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', preConfirm: () => { const name = document.getElementById('swal-productName').value; const description = document.getElementById('swal-productDescription').value; const price = parseFloat(document.getElementById('swal-productPrice').value); const stock = parseInt(document.getElementById('swal-productStock').value); if (!name || isNaN(price) || isNaN(stock)) { Swal.showValidationMessage(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`); return false; } return { name, description, price, stock }; }
            }).then((result) => {
                if (result.isConfirmed) {
                    products[index] = { ...products[index], ...result.value };
                    syncDataToGoogleSheets();
                    refreshUI();
                    Swal.fire('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!', '', 'success');
                }
            });
        }

        function deleteProduct(index) {
            if (userRole !== 'admin') { showAlert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå', 'error'); return; }
            Swal.fire({ title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: '‡∏•‡∏ö'})
            .then((result) => {
                if (result.isConfirmed) {
                    products.splice(index, 1);
                    syncDataToGoogleSheets();
                    Swal.fire({ icon: 'success', title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', timer: 1500, showConfirmButton: false });
                    refreshUI();
                }
            });
        }
        
        document.getElementById('memberForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (userRole !== 'admin') { showAlert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå', 'error'); return; }
            const member = { employeeId: document.getElementById('employeeId').value, firstName: document.getElementById('firstName').value, lastName: document.getElementById('lastName').value, department: document.getElementById('department').value, createdAt: new Date().toISOString(), createdBy: currentUser };
            members.push(member);
            syncDataToGoogleSheets();
            Swal.fire({ icon: 'success', title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', timer: 1500, showConfirmButton: false });
            document.getElementById('memberForm').reset();
            refreshUI();
        });
        
        function displayMembers() {
            const list = document.getElementById('memberList');
            list.innerHTML = '';
            members.forEach((m, i) => {
                const div = document.createElement('div');
                div.className = 'p-3 bg-gray-50 rounded border flex flex-col sm:flex-row justify-between sm:items-center space-y-2 sm:space-y-0';
                div.innerHTML = `<div class="w-full sm:w-auto text-left"><h4 class="font-medium">${m.firstName} ${m.lastName}</h4><p class="text-sm text-gray-600">‡∏£‡∏´‡∏±‡∏™: ${m.employeeId} | ‡πÅ‡∏ú‡∏ô‡∏Å: ${m.department}</p></div><div class="flex space-x-2 flex-shrink-0">${userRole === 'admin' ? `<button onclick="editMember(${i})" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button><button onclick="deleteMember(${i})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">‡∏•‡∏ö</button>`: ''}</div>`;
                list.appendChild(div);
            });
        }
        
        function editMember(index) {
            if (userRole !== 'admin') { showAlert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå', 'error'); return; }
            const m = members[index];
            Swal.fire({ title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å', html: `<div class="space-y-4 text-left"><div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label><input id="swal-employeeId" class="swal2-input w-full" value="${m.employeeId}"></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠</label><input id="swal-firstName" class="swal2-input w-full" value="${m.firstName}"></div><div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input id="swal-lastName" class="swal2-input w-full" value="${m.lastName}"></div></div><div><label class="block text-sm font-medium text-gray-700 mb-1">‡πÅ‡∏ú‡∏ô‡∏Å</label><input id="swal-department" class="swal2-input w-full" value="${m.department}"></div></div>`, focusConfirm: false, showCancelButton: true, confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', preConfirm: () => { const employeeId = document.getElementById('swal-employeeId').value; const firstName = document.getElementById('swal-firstName').value; const lastName = document.getElementById('swal-lastName').value; const department = document.getElementById('swal-department').value; if (!employeeId || !firstName || !lastName || !department) { Swal.showValidationMessage(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô`); return false; } return { employeeId, firstName, lastName, department }; }
            }).then((result) => {
                if (result.isConfirmed) {
                    members[index] = { ...members[index], ...result.value };
                    syncDataToGoogleSheets();
                    refreshUI();
                    Swal.fire('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!', '', 'success');
                }
            });
        }

        function deleteMember(index) {
            if (userRole !== 'admin') { showAlert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå', 'error'); return; }
            Swal.fire({ title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: '‡∏•‡∏ö'})
            .then((result) => {
                if (result.isConfirmed) {
                    members.splice(index, 1);
                    syncDataToGoogleSheets();
                    Swal.fire({ icon: 'success', title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', timer: 1500, showConfirmButton: false });
                    refreshUI();
                }
            });
        }
        
        function addToCartFromGrid(productIndex) {
            const product = products[productIndex];
            if (!product) { return; }

            const quantity = 1;
            const existingCartQuantity = currentCart.find(item => item.productIndex === productIndex)?.quantity || 0;

            if (product.stock < (existingCartQuantity + quantity)) {
                showAlert(`‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠!`, 'error');
                return;
            }

            const existingItem = currentCart.find(item => item.productIndex === productIndex);
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                currentCart.push({ productIndex, name: product.name, price: product.price, quantity });
            }

            showAlert(`‡πÄ‡∏û‡∏¥‡πà‡∏° ${product.name}`, 'success');
            displayCart();
        }

        function confirmPayment() {
            if (currentCart.length === 0) { showAlert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤', 'warning'); return; }
            const total = currentCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const paid = parseFloat(document.getElementById('paidAmount').value) || 0;
            if (paid < total) { showAlert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠', 'error'); return; }
            const memberIndex = document.getElementById('memberSelect').value;
            const member = memberIndex !== '' ? members[parseInt(memberIndex)] : null;
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            const sale = { memberId: memberIndex, memberName: member ? `${member.firstName} ${member.lastName}` : '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', items: [...currentCart], total: total, paid: paid, change: paid - total, paymentMethod: paymentMethod, date: new Date().toISOString(), soldBy: currentUser };
            sale.items.forEach(item => { products[item.productIndex].stock -= item.quantity; });
            sales.push(sale);
            syncDataToGoogleSheets();
            Swal.fire({ icon: 'success', title: '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', text: `‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô: ‡∏ø${paid - total}`, timer: 2000, showConfirmButton: false });
            currentCart = [];
            document.getElementById('memberSelect').value = '';
            document.getElementById('paidAmount').value = '';
            document.getElementById('changeAmount').value = '';
            refreshUI();
        }

        // --- UI REFRESH & DISPLAY ---
        function refreshUI() {
            displayProducts();
            displayMembers();
            displayProductGrid();
            loadMemberOptions();
            updateDashboard();
            updateSalesReport();
            updateMySalesHistory();
            displayAnnouncements();
            displayCart();
        }

        function displayProductGrid(filteredProducts = products) {
            const grid = document.getElementById('productGrid');
            if (!grid) return;
            grid.innerHTML = '';

            filteredProducts.forEach(p => {
                const productIndex = products.findIndex(prod => prod.name === p.name && prod.price === p.price);
                if (p.stock > 0) {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-3 rounded-lg shadow-md cursor-pointer hover:shadow-xl hover:border-orange-400 border-2 border-transparent transition-all';
                    card.onclick = () => addToCartFromGrid(productIndex);

                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-gray-800 text-base leading-tight">${p.name}</h4>
                        </div>
                        <p class="text-xs text-gray-500 mb-3 h-8 overflow-hidden">${p.description || ''}</p>
                        <div class="flex justify-between items-end mt-2">
                            <p class="text-lg font-bold text-orange-600">‡∏ø${p.price}</p>
                            <p class="text-xs text-gray-500">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${p.stock}</p>
                        </div>
                    `;
                    grid.appendChild(card);
                }
            });
        }
        
        function displayAnnouncements() {
            const container = document.getElementById('announcementsContainer');
            if (!container) return;
            container.innerHTML = `
                <div class="p-3 bg-orange-50 rounded border-l-4 border-orange-400">
                    <p class="text-sm">${announcements.promo1}</p>
                </div>
                <div class="p-3 bg-blue-50 rounded border-l-4 border-blue-400">
                    <p class="text-sm">${announcements.promo2}</p>
                </div>
            `;
            const editBtn = document.getElementById('editAnnouncementsBtn');
            if (editBtn) {
                if (userRole === 'admin') {
                    editBtn.classList.remove('hidden');
                } else {
                    editBtn.classList.add('hidden');
                }
            }
        }

        function editAnnouncements() {
            if (userRole !== 'admin') {
                showAlert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', 'error');
                return;
            }
            Swal.fire({
                title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πà‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®',
                html: `
                    <div class="space-y-4 text-left">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® 1 (‡∏™‡∏µ‡∏™‡πâ‡∏°)</label>
                            <input id="swal-promo1" class="swal2-input w-full" value="${announcements.promo1}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® 2 (‡∏™‡∏µ‡∏ü‡πâ‡∏≤)</label>
                            <input id="swal-promo2" class="swal2-input w-full" value="${announcements.promo2}">
                        </div>
                    </div>
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                preConfirm: () => {
                    const promo1 = document.getElementById('swal-promo1').value;
                    const promo2 = document.getElementById('swal-promo2').value;
                    if (!promo1 || !promo2) {
                        Swal.showValidationMessage(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô`);
                        return false;
                    }
                    return { promo1, promo2 };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    announcements.promo1 = result.value.promo1;
                    announcements.promo2 = result.value.promo2;
                    syncDataToGoogleSheets();
                    displayAnnouncements();
                    Swal.fire('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!', '‡∏Ç‡πà‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß', 'success');
                }
            });
        }

        function loadMemberOptions() {
            const select = document.getElementById('memberSelect');
            select.innerHTML = '<option value="">(‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)</option>';
            members.forEach((m, i) => { const o = document.createElement('option'); o.value = i; o.textContent = `${m.firstName} ${m.lastName} (${m.employeeId})`; select.appendChild(o); });
        }

        function displayCart() {
            const cartDiv = document.getElementById('cart');
            cartDiv.innerHTML = '';
            let total = 0;
            currentCart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                const div = document.createElement('div');
                div.className = 'p-3 bg-gray-50 rounded border flex justify-between items-center';
                div.innerHTML = `<div><h4 class="font-medium">${item.name}</h4><p class="text-sm text-gray-600">‡∏ø${item.price} x ${item.quantity} = ‡∏ø${itemTotal}</p></div><button onclick="removeFromCart(${index})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs flex-shrink-0">‡∏•‡∏ö</button>`;
                cartDiv.appendChild(div);
            });
            if (currentCart.length === 0) {
                cartDiv.innerHTML = `<p class="text-center text-gray-500">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á</p>`;
            }
            document.getElementById('totalAmount').textContent = `‡∏ø${total}`;
            calculateChange();
            handlePaymentMethodChange(); 
        }

        function removeFromCart(index) { currentCart.splice(index, 1); displayCart(); }
        function calculateChange() { const total = currentCart.reduce((sum, item) => sum + (item.price * item.quantity), 0); const paid = parseFloat(document.getElementById('paidAmount').value) || 0; const change = paid - total; document.getElementById('changeAmount').value = change >= 0 ? `‡∏ø${change.toFixed(2)}` : '‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠'; }
        
        function updateDashboard() {
            const today = new Date().toDateString();
            const todaySales = sales.filter(s => new Date(s.date).toDateString() === today);
            document.getElementById('todaySales').textContent = `‡∏ø${todaySales.reduce((sum, s) => sum + s.total, 0)}`;
            document.getElementById('memberCount').textContent = members.length;
            document.getElementById('productCount').textContent = products.length;
        }

        function updateSalesReport() {
            if (userRole !== 'admin') return;
            const today = new Date();
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
            const todaySales = sales.filter(s => new Date(s.date).toDateString() === today.toDateString());
            const weeklySales = sales.filter(s => new Date(s.date) >= weekAgo);
            const monthlySales = sales.filter(s => new Date(s.date) >= monthAgo);
            document.getElementById('reportTodaySales').textContent = `‡∏ø${todaySales.reduce((s, c) => s + c.total, 0)}`;
            document.getElementById('reportWeeklySales').textContent = `‡∏ø${weeklySales.reduce((s, c) => s + c.total, 0)}`;
            document.getElementById('reportMonthlySales').textContent = `‡∏ø${monthlySales.reduce((s, c) => s + c.total, 0)}`;
            document.getElementById('reportMemberCount').textContent = members.length;
            updateSalesChart();
            updateTopProducts();
        }

        function updateSalesChart() {
            if (userRole !== 'admin') return;
            const ctx = document.getElementById('salesChart').getContext('2d');
            if (salesChartInstance) {
                salesChartInstance.destroy();
            }

            const labels = Array.from({length: 7}, (_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - i);
                return d.toLocaleDateString('th-TH', { weekday: 'short' });
            }).reverse();

            const data = Array.from({length: 7}, (_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - i);

                const dayTotal = sales.filter(s => {
                    if (!s.date) return false;
                    const saleDate = new Date(s.date);
                    return saleDate.getFullYear() === d.getFullYear() &&
                           saleDate.getMonth() === d.getMonth() &&
                           saleDate.getDate() === d.getDate();
                }).reduce((sum, s) => sum + s.total, 0);

                return dayTotal;
            }).reverse();

            salesChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)',
                        data: data,
                        backgroundColor: 'rgba(251, 146, 60, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateTopProducts() {
            if (userRole !== 'admin') return;
            const salesCount = {};
            sales.forEach(s => s.items.forEach(i => { salesCount[i.name] = (salesCount[i.name] || 0) + i.quantity; }));
            const sorted = Object.entries(salesCount).sort(([,a], [,b]) => b - a).slice(0, 5);
            const container = document.getElementById('topProducts');
            container.innerHTML = '';
            sorted.forEach(([name, quantity], i) => {
                const div = document.createElement('div');
                div.className = 'p-3 bg-gray-50 rounded border flex justify-between items-center';
                div.innerHTML = `<div class="flex items-center space-x-3"><span class="bg-orange-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold">${i + 1}</span><span class="font-medium">${name}</span></div><span class="text-gray-600">${quantity} ‡∏ä‡∏¥‡πâ‡∏ô</span>`;
                container.appendChild(div);
            });
        }

        function updateMySalesHistory() {
            if (userRole === 'admin') return;
            const mySales = sales.filter(s => s.soldBy === currentUser);

            // Calculate totals
            const totalSales = mySales.reduce((sum, s) => sum + s.total, 0);
            const totalCashSales = mySales.filter(s => s.paymentMethod === '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î' || !s.paymentMethod).reduce((sum, s) => sum + s.total, 0);
            const totalTransferSales = mySales.filter(s => s.paymentMethod === '‡πÇ‡∏≠‡∏ô').reduce((sum, s) => sum + s.total, 0);
            const todaySales = mySales.filter(s => new Date(s.date).toDateString() === new Date().toDateString());
            
            // Update summary cards
            document.getElementById('myTotalSales').textContent = `‡∏ø${totalSales}`;
            document.getElementById('myTotalCashSales').textContent = `‡∏ø${totalCashSales}`;
            document.getElementById('myTotalTransferSales').textContent = `‡∏ø${totalTransferSales}`;
            document.getElementById('myOrdersToday').textContent = todaySales.length;
            
            // Update sales list
            const list = document.getElementById('mySalesList');
            list.innerHTML = '';
            const recent = mySales.slice(-20).reverse();
            recent.forEach(s => {
                const div = document.createElement('div');
                div.className = 'p-4 bg-gray-50 rounded border';
                
                // Add a badge for payment method
                const paymentMethod = s.paymentMethod || '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î'; // Default to cash for old records
                const paymentBadge = paymentMethod === '‡πÇ‡∏≠‡∏ô' 
                    ? `<span class="text-xs font-medium bg-sky-100 text-sky-800 px-2 py-0.5 rounded-full">‡πÇ‡∏≠‡∏ô</span>`
                    : `<span class="text-xs font-medium bg-green-100 text-green-800 px-2 py-0.5 rounded-full">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</span>`;

                div.innerHTML = `
                    <div class="flex flex-col sm:flex-row justify-between sm:items-start space-y-2 sm:space-y-0">
                        <div>
                            <h4 class="font-medium">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${s.memberName}</h4>
                            <p class="text-sm text-gray-600">${s.items.map(i => `${i.name} x${i.quantity}`).join(', ')}</p>
                        </div>
                        <div class="text-left sm:text-right flex-shrink-0">
                            <p class="font-bold text-green-600">‡∏ø${s.total}</p>
                            <div class="flex items-center justify-start sm:justify-end space-x-2 mt-1">
                                ${paymentBadge}
                                <p class="text-xs text-gray-500">${new Date(s.date).toLocaleString('th-TH')}</p>
                            </div>
                        </div>
                    </div>`;
                list.appendChild(div);
            });
            if (recent.length === 0) { list.innerHTML = '<p class="text-gray-500 text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</p>'; }
        }

        function showAlert(message, type = 'info') {
            Swal.fire({ icon: type, title: message, timer: 2000, showConfirmButton: false, toast: true, position: 'top-end' });
        }

    </script>
</body>
</html>

